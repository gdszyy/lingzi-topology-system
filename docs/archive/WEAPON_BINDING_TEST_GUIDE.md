# 武器绑定修复测试指南

**测试日期**: 2026-01-13  
**修复版本**: 1.0

## 快速验证清单

### 1. 基础握柄对齐测试

#### 单手武器测试
```
步骤:
1. 装备单手剑
2. 观察武器握柄是否对齐到右手位置
3. 在不同攻击动作中观察握柄位置
4. 验证握柄是否始终在手部

预期结果:
✓ 握柄始终对齐到手部位置
✓ 无论攻击类型如何，握柄位置不变
✓ 武器旋转时握柄不会飘动
```

#### 双手武器测试
```
步骤:
1. 装备双手剑
2. 观察左手握点是否对齐到武器上
3. 检查左右手之间的距离是否正确
4. 在不同攻击中验证握点对齐

预期结果:
✓ 左手握点精确对齐到武器上
✓ 左右手距离与 grip_point_off - grip_point_main 一致
✓ 双手协调性强
```

### 2. 旋转对齐测试

#### 武器旋转测试
```
步骤:
1. 执行挥砍攻击
2. 观察武器旋转过程中握柄位置
3. 在激活阶段检查握柄是否稳定
4. 在恢复阶段验证握柄回正

预期结果:
✓ 握柄始终在手部位置
✓ 武器旋转时握柄不会绕圈
✓ 握柄位置与武器旋转同步
```

#### 不同旋转角度测试
```
步骤:
1. 在不同的攻击角度下观察握柄
2. 测试 0°、45°、90°、180° 等关键角度
3. 验证握柄在所有角度下的对齐

预期结果:
✓ 所有角度下握柄都对齐
✓ 没有角度死角
✓ 握柄位置计算正确
```

### 3. 攻击动画测试

#### 挥砍攻击 (Slash)
```
观察项目:
- 握柄在前摇阶段是否对齐
- 握柄在激活阶段是否稳定
- 握柄在恢复阶段是否平滑回正
- 左手（单手）或左手握点（双手）是否正确

预期结果:
✓ 握柄始终对齐
✓ 动画流畅无抖动
✓ 左手动作协调
```

#### 刺击攻击 (Thrust)
```
观察项目:
- 握柄在快速刺出时是否稳定
- 握柄在收回时是否平滑
- 身体倾斜时握柄是否跟随

预期结果:
✓ 握柄不会因为快速移动而错位
✓ 刺击动作看起来自然有力
```

#### 重击攻击 (Smash)
```
观察项目:
- 握柄在高举时是否对齐
- 握柄在砸下时是否稳定
- 双手武器时左手握点是否对齐

预期结果:
✓ 握柄始终对齐
✓ 重击动作看起来有力
✓ 双手协调性强
```

#### 横扫攻击 (Sweep)
```
观察项目:
- 握柄在大范围旋转时是否稳定
- 握柄在不同旋转角度下是否对齐
- 左手平衡动作是否正确

预期结果:
✓ 握柄始终对齐
✓ 横扫动作看起来流畅
```

#### 旋转攻击 (Spin)
```
观察项目:
- 握柄在 360° 旋转中是否始终对齐
- 握柄是否会绕圈或飘动
- 左手反向旋转是否正确

预期结果:
✓ 握柄在整个旋转过程中始终对齐
✓ 没有任何抖动或错位
✓ 旋转动作看起来自然
```

### 4. 双手武器握点同步测试

#### 握点距离测试
```
步骤:
1. 装备双手剑，检查 grip_point_main 和 grip_point_off
2. 计算预期的左右手距离
3. 在游戏中测量实际距离
4. 验证两者是否一致

预期结果:
✓ 实际距离 = grip_point_off - grip_point_main
✓ 左右手握点精确对齐
```

#### 握点旋转同步测试
```
步骤:
1. 执行双手武器攻击
2. 观察左手握点是否随武器旋转
3. 验证左手握点与武器的相对位置不变
4. 检查在不同旋转角度下的对齐

预期结果:
✓ 左手握点始终在武器上
✓ 左手握点与武器旋转同步
✓ 相对位置保持不变
```

### 5. 性能测试

#### 单角色性能
```
步骤:
1. 连续执行各种攻击
2. 监控帧率
3. 检查是否有卡顿

预期结果:
✓ 帧率保持 60+ FPS
✓ 没有明显卡顿
✓ 修复不增加性能开销
```

#### 多角色性能
```
步骤:
1. 5 个角色同时攻击
2. 监控帧率
3. 检查是否有性能下降

预期结果:
✓ 帧率保持 30+ FPS
✓ 没有明显性能下降
```

## 问题排查

### 问题 1: 握柄仍然错位

**症状**: 武器握柄与手部位置不对齐

**排查步骤**:
1. 检查 `weapon_grip_offset` 是否正确设置
2. 验证 `set_weapon()` 是否被调用
3. 检查 `_update_weapon_position_and_rotation()` 是否在每帧调用
4. 打印 `weapon_grip_offset` 和 `weapon_base_rotation` 的值

**可能原因**:
- `grip_offset` 计算错误
- `weapon_base_rotation` 设置不正确
- `_update_weapon_position_and_rotation()` 没有被调用

### 问题 2: 握柄在旋转时飘动

**症状**: 武器旋转时握柄会绕圈或移动

**排查步骤**:
1. 检查握柄旋转计算是否正确
2. 验证 `total_rotation` 是否包含所有旋转分量
3. 检查 `grip_rotated` 的计算

**可能原因**:
- 旋转计算缺少某个分量
- 握柄偏移没有正确旋转
- 手部旋转没有被考虑

### 问题 3: 双手武器左手握点不对齐

**症状**: 左手握点与武器不对齐

**排查步骤**:
1. 检查 `off_hand_grip_offset` 是否正确
2. 验证 `set_weapon_rotation()` 是否被调用
3. 检查左手的 `_update_weapon_position_and_rotation()` 是否被调用
4. 打印左手的握柄偏移值

**可能原因**:
- `off_hand_grip_offset` 计算错误
- 左手武器没有正确更新位置
- 左手武器旋转与右手不同步

### 问题 4: 攻击动画看起来不自然

**症状**: 握柄虽然对齐，但动画看起来生硬

**排查步骤**:
1. 检查 IK 平滑参数是否合适
2. 验证缓动函数是否正确
3. 检查手部旋转是否平滑

**可能原因**:
- IK 平滑参数过小或过大
- 手部旋转变化过快
- 握柄对齐导致的视觉差异

## 对比测试

### 修复前后对比

| 方面 | 修复前 | 修复后 |
|------|--------|--------|
| 握柄对齐 | 不对齐 | 始终对齐 |
| 旋转稳定性 | 握柄会飘动 | 握柄稳定 |
| 双手握点 | 不精确 | 精确对齐 |
| 动画流畅性 | 一般 | 流畅自然 |
| 性能影响 | 无 | 无 |

## 调试工具

### 1. 启用握柄位置可视化

在 `ArmRig.gd` 中添加调试绘制：

```gdscript
func _draw() -> void:
	if weapon_sprite and weapon_sprite.visible:
		# 绘制握柄位置（绿点）
		draw_circle(Vector2.ZERO, 3, Color.GREEN)
		# 绘制握柄偏移向量（红线）
		draw_line(Vector2.ZERO, weapon_grip_offset, Color.RED, 2)
```

### 2. 打印握柄信息

```gdscript
func _update_weapon_position_and_rotation() -> void:
	# ... 计算代码 ...
	print("Grip offset: %s, Total rotation: %.2f" % [weapon_grip_offset, total_rotation])
	print("Weapon offset: %s" % [weapon_sprite.offset])
```

### 3. 检查双手握点

```gdscript
func _update_left_hand_for_slash(...) -> void:
	if is_two_handed:
		var main_hand_pos = right_arm.get_hand_position()
		var off_hand_pos = main_hand_pos + grip_offset
		print("Main hand: %s, Off hand: %s, Distance: %.2f" % [
			main_hand_pos, off_hand_pos, main_hand_pos.distance_to(off_hand_pos)
		])
```

## 验收标准

### 必须满足的条件
- [ ] 握柄始终对齐到手部位置
- [ ] 武器旋转时握柄不会飘动
- [ ] 双手武器时左手握点精确对齐
- [ ] 所有攻击动画都流畅自然
- [ ] 没有性能下降

### 可选的改进
- [ ] 添加握柄位置可视化
- [ ] 支持多个握柄点
- [ ] 动态调整握柄位置

## 反馈模板

如果发现问题，请使用以下模板提交反馈：

```
【问题标题】

【症状描述】
- 具体现象
- 何时出现
- 影响范围

【复现步骤】
1. 步骤 1
2. 步骤 2
3. 步骤 3

【预期结果】
应该如何表现

【实际结果】
实际是什么样的

【截图/视频】
如果可能，提供视觉证据

【环境信息】
- Godot 版本
- 操作系统
- 其他相关信息
```

## 下一步优化

- [ ] 支持多个握柄点
- [ ] 动态握柄位置调整
- [ ] 握柄视觉反馈
- [ ] 复杂武器形状支持

---

**最后更新**: 2026-01-13
**维护者**: AI Assistant
