# 战斗系统攻击动画优化日志

**版本**: 2.0  
**日期**: 2026-01-13  
**优化方向**: 双手协调动作 + 武器挥舞效果增强

## 概述

本次优化针对战斗系统中的攻击动画进行了全面改进，主要目标是：
1. 实现双手协调的攻击动作（之前只有右手在动）
2. 增强武器"挥出去"的视觉效果
3. 为不同攻击类型设计更生动的动画

## 主要改进

### 1. CombatAnimator.gd - 核心攻击动画控制器

#### 新增功能
- **双手协调系统**: 为每种攻击类型实现了专门的左手动作
- **挥舞动量系统**: 在激活阶段增加额外的动量，使武器挥舞更有力度
- **缓动函数**: 添加了 `_ease_out_cubic`、`_ease_in_cubic`、`_ease_in_out_cubic` 用于平滑的动画曲线

#### 优化的攻击类型

**1. 挥砍 (SLASH) - 增强版**
```
前摇阶段 (Windup):
  - 手臂向后拉，准备挥舞
  - 身体轻微反向旋转
  - 武器略微后收

激活阶段 (Active):
  - 武器快速挥出（挥舞半径增加）
  - 动量增加武器伸出距离
  - 身体跟随旋转
  - 左手做平衡动作（单手）或跟随握持（双手）

恢复阶段 (Recovery):
  - 平滑收回动作
  - 身体恢复中立姿态
```

**2. 刺击 (THRUST) - 增强版**
```
前摇阶段:
  - 手臂后收，身体后仰
  - 准备快速刺出

激活阶段:
  - 手臂快速伸出（使用 ease_out_cubic 加速度）
  - 身体前倾增加力度
  - 左手向后平衡

恢复阶段:
  - 缓慢收回手臂
  - 身体恢复平衡
```

**3. 重击 (SMASH) - 增强版**
```
前摇阶段:
  - 武器高举过头
  - 手臂收紧准备

激活阶段:
  - 武器大幅伸出（最大挥舞范围）
  - 动量增加伸出距离
  - 双手都用力（双手武器）或左手辅助（单手）

恢复阶段:
  - 平滑恢复
```

**4. 横扫 (SWEEP) - 增强版**
```
- 大范围的水平挥舞
- 身体大幅转动
- 左手做大幅平衡动作
```

**5. 旋转 (SPIN) - 增强版**
```
- 手臂绕身体旋转
- 双手武器时左手跟随握持
- 单手武器时左手反向旋转保持平衡
```

#### 左手协调动作细节

**单手武器的左手动作**:
- 挥砍: 做平衡动作，与右手相反
- 刺击: 向后平衡，配合身体前倾
- 重击: 辅助发力，同向挥动
- 横扫: 大幅平衡，增强转身感

**双手武器的左手动作**:
- 始终握在武器上
- 跟随主手位置和旋转
- 根据握点偏移调整位置
- 与主手保持协调

### 2. WeaponPhysics.gd - 武器物理系统增强

#### 新增参数
- `swing_overshoot_factor`: 挥舞超调因子（产生超调效果）
- `swing_momentum_multiplier`: 挥舞动量倍数
- `active_phase_acceleration`: 激活阶段的加速度倍数

#### 优化的物理模型

**根据攻击阶段调整物理参数**:

```
前摇阶段 (Windup):
  - 快速响应目标旋转
  - 刚度提高 1.5 倍
  - 阻尼降低 0.8 倍
  - 最大角速度提高 1.2 倍

激活阶段 (Active):
  - 增加加速度，产生"挥出去"的感觉
  - 刚度提高 1.5 倍（动量倍数）
  - 阻尼降低 0.6 倍
  - 最大角速度提高 1.5 倍
  - 添加额外加速度基于目标旋转变化速度

恢复阶段 (Recovery):
  - 缓慢回正
  - 刚度降低 0.8 倍
  - 阻尼提高 1.2 倍
  - 最大角速度降低 0.9 倍
```

**武器类型特化参数**:
- 大剑: 沉重但挥舞范围大 (动量 1.3)
- 剑: 平衡的挥舞 (动量 1.5)
- 匕首: 快速灵活 (动量 1.8)
- 矛: 长杆武器，挥舞需要力量 (动量 1.2)
- 法杖: 灵活但有惯性 (动量 1.4)

### 3. ArmRig.gd - 手臂渲染增强

#### 新增功能
- **武器拖尾系统**: 在武器快速移动时显示拖尾效果
- **武器缩放效果**: 挥舞时武器可以缩放
- **武器发光效果**: 可配置的发光强度
- **武器挥舞动画**: 播放缩放和发光的组合效果

#### 实现细节

**武器拖尾**:
```gdscript
- 记录武器高速移动时的位置点
- 最多保留 8 个点形成拖尾线
- 拖尾逐渐消失（衰减效果）
- 只在武器速度 > 50 时显示
```

**武器缩放**:
```gdscript
- 可通过 set_weapon_scale() 调整
- 在挥舞时可达到 1.1 倍
- 配合缓动函数产生弹性效果
```

**武器发光**:
```gdscript
- 通过调整 modulate 和 self_modulate 实现
- 强度范围 0-1
- 发光时偏向黄色
```

## 技术细节

### 动画阶段划分

所有攻击动画都分为三个阶段：

1. **前摇 (Windup)**: 准备阶段
   - 手臂摆到起始位置
   - 身体做准备动作
   - 动画进度: 0 ~ windup_ratio

2. **激活 (Active)**: 攻击执行阶段
   - 快速挥舞武器
   - 产生最大动量
   - 动画进度: windup_ratio ~ active_ratio
   - **此阶段触发 hit_frame_reached 信号**

3. **恢复 (Recovery)**: 收回阶段
   - 平滑收回动作
   - 恢复待机姿态
   - 动画进度: active_ratio ~ 1.0

### 坐标系统

- **肩膀位置**: 左肩 (-12, 0)，右肩 (12, 0)
- **手臂长度**: 上臂 18 单位，前臂 16 单位
- **挥舞半径**: 根据攻击类型 20-35 单位
- **武器伸出**: 根据阶段 -5 ~ 20 单位

### 缓动函数

```gdscript
ease_out_cubic(t):  # 快速开始，缓慢结束
  return 1.0 - pow(1.0 - t, 3)

ease_in_cubic(t):   # 缓慢开始，快速结束
  return t * t * t

ease_in_out_cubic(t):  # 两端缓慢，中间快速
  if t < 0.5:
    return 4 * t * t * t
  else:
    return 1 - pow(-2 * t + 2, 3) / 2
```

## 性能考虑

- 武器拖尾最多 8 个点，不会造成性能问题
- 所有计算都在 _process 中进行，避免额外开销
- 物理参数根据武器类型缓存，不会每帧重新计算
- 缓动函数使用简单的数学运算，性能开销极小

## 向后兼容性

- 所有新增功能都是可选的（通过导出参数控制）
- 现有的攻击数据格式不变
- 可以逐步启用新功能而不影响现有内容

## 测试建议

1. **视觉测试**:
   - 观察不同攻击类型的双手动作是否协调
   - 检查武器是否有明显的"挥出去"的感觉
   - 验证武器拖尾效果是否流畅

2. **性能测试**:
   - 同时多个角色攻击时的帧率
   - 武器拖尾启用/禁用的性能差异

3. **动画流畅性**:
   - 前摇、激活、恢复三个阶段的过渡是否自然
   - 左手动作是否与右手协调
   - 身体倾斜是否合理

## 配置建议

### 对于轻武器（匕首、短剑）:
```
ik_smoothing: 18.0  # 更快的响应
swing_momentum_multiplier: 1.8
weapon_scale_on_swing: 1.15
```

### 对于重武器（大剑、战斧）:
```
ik_smoothing: 12.0  # 更慢的响应
swing_momentum_multiplier: 1.3
weapon_scale_on_swing: 1.05
```

### 对于双手武器:
```
off_hand_grip_offset: Vector2(0, 20)  # 副手握点
# 左手会自动跟随主手
```

## 已知限制

1. 武器拖尾只在 2D 平面上显示
2. 发光效果受场景光照影响
3. 缩放效果在武器精灵较小时可能不明显

## 未来改进方向

1. 添加更多攻击类型（如下劈、上挑等）
2. 支持连击时的手臂过渡动画
3. 根据角色属性（力量、敏捷）动态调整动画速度
4. 添加武器特效（如魔法武器的能量效果）
5. 支持多武器组合的协调动作

## 相关文件

- `scripts/combat/combat_animator.gd` - 核心攻击动画控制器
- `scripts/combat/weapon_physics.gd` - 武器物理系统
- `scripts/combat/arm_rig.gd` - 手臂渲染和 IK
- `scripts/combat/body_animation_controller.gd` - 全身动画（移动/飞行）
- `scripts/combat/player_visuals.gd` - 玩家视觉系统

## 总结

这次优化通过以下方式显著改进了战斗动画的视觉效果：

1. ✅ **双手协调**: 左手不再闲置，而是做出有意义的平衡或协助动作
2. ✅ **武器挥舞**: 通过增加挥舞半径、伸出距离和动量，使武器更有"挥出去"的感觉
3. ✅ **视觉反馈**: 添加了拖尾、缩放、发光等效果，增强了攻击的视觉冲击力
4. ✅ **动画流畅性**: 使用缓动函数和分阶段控制，使动画更加自然流畅
5. ✅ **灵活配置**: 所有参数都可导出调整，支持不同武器和角色的定制

攻击动画现在应该看起来更加生动、有力，能够给玩家带来更好的战斗体验。
